# syntax=docker/dockerfile:1.4

ARG USERNAME="${USERNAME:-hikaru}"
ARG CONTAINER_ID="${CONTAINER_ID:-orora-cli}"
ARG SOURCE_IMAGE_NAME="${SOURCE_IMAGE_NAME:-wolfi-toolbox}"
ARG SOURCE_IMAGE_REGISTRY="${SOURCE_IMAGE_REGISTRY:-ghcr.io/ublue-os}"
ARG SOURCE_IMAGE="${SOURCE_IMAGE_REGISTRY}/${SOURCE_IMAGE_NAME}"

# ============================================================================================= #
# ORORA_CLI
# ============================================================================================= #

FROM $SOURCE_IMAGE:latest

# ================================= #

LABEL maintainer="lecoqjacob@gmail.com" \
    com.github.containers.toolbox="true" \
    summary="A cloud-native terminal experience" \
    usage="This image is meant to be used with the toolbox or distrobox command"

ARG USERNAME
ARG CONTAINER_ID

ENV PATH="/root/.cargo/bin:${PATH}"

# ================================= #

COPY toolboxes/orora-cli/files /
COPY toolboxes/orora-cli/extra-packages \
    toolboxes/orora-cli/scripts \
    /tmp/

RUN \
    --mount=type=cache,target=/var/cache/apk \
    apk update && apk upgrade && \
    grep -v '^#' /tmp/extra-packages | xargs apk add --no-cache --update && \
    mv /home/linuxbrew /home/homebrew && \
    rm -rf /tmp/extra-packages

RUN \
    mkdir -p /etc/sudoers.d/ && \
    useradd -ms /bin/bash "${USERNAME}" && \
    echo -e "${USERNAME} ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/${USERNAME} && \
    chmod 0440 /etc/sudoers.d/${USERNAME} && \
    # Change user shell to FISH
    chsh --shell /usr/bin/fish ${USERNAME}

# Patch /usr/bin/entrypoint
RUN sed -i '/missing_packages=0/,/# Set SHELL to the install path inside the container/ s/^/#/' /usr/bin/entrypoint && \
    sed -i '/# Set SHELL to the install path inside the container/a touch /.containersetupdone' /usr/bin/entrypoint

# Use and configure bash, retrieve bash-prexec, and cleanup
RUN curl https://raw.githubusercontent.com/rcaloras/bash-preexec/master/bash-preexec.sh -o /tmp/bash-prexec && \
    mkdir -p /usr/share/ && \
    cp /tmp/bash-prexec /usr/share/bash-prexec && \
    rm -rf /tmp/*

# ==========
# USER
# ==========
USER ${USERNAME}
WORKDIR /var/home/${USERNAME}

RUN sudo chsh --shell \
    /usr/bin/fish ${USERNAME}